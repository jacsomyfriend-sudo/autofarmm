-- //////////////////////////////////////////////////////////////
-- //  DUAL ALT FARM - FIXED AUTO EXECUTION SCRIPT
-- //////////////////////////////////////////////////////////////

-- Configuration
local delay = getgenv().delay or 4
local firstAcc = getgenv().firstAcc or "WVWWWWWVWWWWWWWWWW"
local secondAcc = getgenv().secondAcc or "WVWWWWWVWWWWWWWWWWW"

local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local DUEL_GAME_ID = 10449761463
local LOBBY_GAME_ID = 12360882630
local LOBBY_SPAWN_POSITION = Vector3.new(181, 439, -1076)

-- Ensure we wait for player to fully load
if not LocalPlayer then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    LocalPlayer = Players.LocalPlayer
end

repeat task.wait() until LocalPlayer

print([[
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë            ü§ñ DUAL ALT FARM AUTO EXECUTE ü§ñ              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

Configuration:
  ‚Ä¢ Delay: ]] .. delay .. [[ seconds
  ‚Ä¢ First Account: ]] .. firstAcc .. [[

  ‚Ä¢ Second Account: ]] .. secondAcc .. [[

  ‚Ä¢ Current Account: ]] .. LocalPlayer.Name .. [[

]])

-- //////////////////////////////////////////////////////////////
-- // BLACK SCREEN OVERLAY WITH RANK DISPLAY
-- //////////////////////////////////////////////////////////////

local PlayerGui = LocalPlayer:WaitForChild("PlayerGui", 10)

-- Create or get existing GUI
local ScreenGui = PlayerGui:FindFirstChild("AltFarmGui")
if ScreenGui then
    ScreenGui:Destroy()
end

ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AltFarmGui"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.DisplayOrder = 999999
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Wait a moment before parenting to ensure it loads
task.wait(0.5)
ScreenGui.Parent = PlayerGui

-- Black Screen
local BlackScreen = Instance.new("Frame")
BlackScreen.Name = "BlackScreen"
BlackScreen.Size = UDim2.new(1, 0, 1, 100)
BlackScreen.Position = UDim2.new(0, 0, 0, -50)
BlackScreen.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BlackScreen.BorderSizePixel = 0
BlackScreen.ZIndex = 999998
BlackScreen.Visible = true
BlackScreen.Parent = ScreenGui

-- Account Name Display
local AccountLabel = Instance.new("TextLabel")
AccountLabel.Name = "AccountLabel"
AccountLabel.Size = UDim2.new(0, 500, 0, 50)
AccountLabel.Position = UDim2.new(0.5, -250, 0.3, 0)
AccountLabel.BackgroundTransparency = 1
AccountLabel.Text = "Account: " .. LocalPlayer.Name
AccountLabel.Font = Enum.Font.GothamBold
AccountLabel.TextSize = 32
AccountLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
AccountLabel.TextStrokeTransparency = 0.5
AccountLabel.ZIndex = 999999
AccountLabel.Parent = BlackScreen

-- Rank Display
local RankLabel = Instance.new("TextLabel")
RankLabel.Name = "RankLabel"
RankLabel.Size = UDim2.new(0, 400, 0, 100)
RankLabel.Position = UDim2.new(0.5, -200, 0.45, 0)
RankLabel.BackgroundTransparency = 1
RankLabel.Text = "üëë\nLoading Rank...\nüëë"
RankLabel.Font = Enum.Font.GothamBold
RankLabel.TextSize = 48
RankLabel.TextColor3 = Color3.fromRGB(255, 215, 0) -- Gold
RankLabel.TextStrokeTransparency = 0.3
RankLabel.TextStrokeColor3 = Color3.fromRGB(139, 69, 19)
RankLabel.ZIndex = 999999
RankLabel.Parent = BlackScreen

-- Status Label
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(0, 700, 0, 50)
StatusLabel.Position = UDim2.new(0.5, -350, 0.65, 0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "üîÑ Initializing Farm System..."
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 26
StatusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
StatusLabel.TextStrokeTransparency = 0.5
StatusLabel.ZIndex = 999999
StatusLabel.Parent = BlackScreen

-- Round Counter Display
local RoundLabel = Instance.new("TextLabel")
RoundLabel.Name = "RoundLabel"
RoundLabel.Size = UDim2.new(0, 400, 0, 40)
RoundLabel.Position = UDim2.new(0.5, -200, 0.75, 0)
RoundLabel.BackgroundTransparency = 1
RoundLabel.Text = "Round: 1"
RoundLabel.Font = Enum.Font.GothamBold
RoundLabel.TextSize = 28
RoundLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
RoundLabel.TextStrokeTransparency = 0.5
RoundLabel.ZIndex = 999999
RoundLabel.Parent = BlackScreen

print("‚úÖ Black screen GUI created and visible")

-- Toggle black screen with P key
local blackScreenEnabled = true
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.P then
        blackScreenEnabled = not blackScreenEnabled
        BlackScreen.Visible = blackScreenEnabled
        print(blackScreenEnabled and "üñ§ Black screen ENABLED" or "üëÅÔ∏è Black screen DISABLED")
    end
end)

-- Update rank display
task.spawn(function()
    task.wait(2)
    
    pcall(function()
        local ls = LocalPlayer:WaitForChild("leaderstats", 10)
        if not ls then 
            RankLabel.Text = "üëë\nNo Rank Data\nüëë"
            return 
        end
        
        local rank = ls:FindFirstChild("Solo Rank") or ls:FindFirstChild("Rank")
        if not rank then 
            RankLabel.Text = "üëë\nNo Rank Found\nüëë"
            return 
        end
        
        RankLabel.Text = "üëë\n" .. tostring(rank.Value) .. "\nüëë"
        print("üìä Rank loaded: " .. tostring(rank.Value))
        
        rank:GetPropertyChangedSignal("Value"):Connect(function()
            RankLabel.Text = "üëë\n" .. tostring(rank.Value) .. "\nüëë"
            print("üìä Rank updated: " .. tostring(rank.Value))
        end)
    end)
end)

-- //////////////////////////////////////////////////////////////
-- // UTILITY FUNCTIONS
-- //////////////////////////////////////////////////////////////

local function updateStatus(message)
    StatusLabel.Text = "üîÑ " .. message
    print("üìä " .. message)
end

local function updateRound(round)
    RoundLabel.Text = "Round: " .. round
end

local function resetCharacter()
    updateStatus("Resetting character...")
    
    local success = pcall(function()
        if LocalPlayer.Character then
            local Humanoid = LocalPlayer.Character:FindFirstChild("Humanoid")
            if Humanoid and Humanoid.Health > 0 then
                Humanoid.Health = 0
                print("‚úÖ Character reset initiated")
                return true
            end
        end
    end)
    
    return success
end

local function waitForCharacterRespawn()
    updateStatus("Waiting for respawn...")
    print("‚è≥ Waiting for character respawn...")
    
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    
    -- Wait for humanoid to be added
    local humanoid = character:WaitForChild("Humanoid", 15)
    if not humanoid then 
        warn("‚ùå Humanoid not found")
        return nil 
    end
    
    -- If dead, wait for respawn
    if humanoid.Health <= 0 then
        print("‚è≥ Character is dead, waiting for respawn...")
        humanoid.Died:Wait()
        character = LocalPlayer.CharacterAdded:Wait()
        humanoid = character:WaitForChild("Humanoid", 15)
    end
    
    -- Wait for HumanoidRootPart
    local hrp = character:WaitForChild("HumanoidRootPart", 15)
    if not hrp then 
        warn("‚ùå HumanoidRootPart not found")
        return nil 
    end
    
    -- Extra wait for full load
    task.wait(1)
    print("‚úÖ Character fully respawned and loaded")
    
    return character
end

local function teleportToRandomLobbyServer()
    updateStatus("Finding random lobby server...")
    print("üåÄ Finding random lobby server...")
    
    pcall(function()
        local targetPlaceId = LOBBY_GAME_ID
        local Servers = "https://games.roblox.com/v1/games/" .. targetPlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
        local Server, Next = nil, nil
        
        local function ListServers(cursor)
            local Raw = game:HttpGet(Servers .. ((cursor and "&cursor=" .. cursor) or ""))
            return HttpService:JSONDecode(Raw)
        end
        
        repeat
            local ServerList = ListServers(Next)
            Server = ServerList.data[math.random(1, math.max(1, math.floor(#ServerList.data / 3)))]
            Next = ServerList.nextPageCursor
        until Server
        
        if Server.playing < Server.maxPlayers then
            print("‚úÖ Found server! Teleporting...")
            TeleportService:TeleportToPlaceInstance(targetPlaceId, Server.id, LocalPlayer)
        end
    end)
end

local function teleportToPosition(position)
    updateStatus("Moving to spawn position...")
    
    local character = LocalPlayer.Character
    if not character then 
        warn("‚ùå No character found for teleport")
        return false 
    end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then 
        warn("‚ùå No HumanoidRootPart found for teleport")
        return false 
    end
    
    hrp.CFrame = CFrame.new(position)
    print("‚úÖ Teleported to position: " .. tostring(position))
    return true
end

local function getCurrentGameId()
    return game.PlaceId
end

-- //////////////////////////////////////////////////////////////
-- // ACCOUNT ROLES
-- //////////////////////////////////////////////////////////////

local isFirstAccount = (LocalPlayer.Name == firstAcc)
local isSecondAccount = (LocalPlayer.Name == secondAcc)

if not isFirstAccount and not isSecondAccount then
    warn("‚ö†Ô∏è Account not configured: " .. LocalPlayer.Name)
    updateStatus("‚ùå Not a configured account!")
    RankLabel.Text = "‚ùå\nNot Configured\n‚ùå"
    return
end

local accountRole = isFirstAccount and "FIRST (Alt 1)" or "SECOND (Alt 2)"
print("‚úÖ Account Role: " .. accountRole)
updateStatus("Account: " .. accountRole)

-- Round counter (persistent across teleports)
if not _G.AltFarmRoundCounter then
    _G.AltFarmRoundCounter = 1
end

-- Track if lobby teleport has been done
if not _G.LobbyTeleportDone then
    _G.LobbyTeleportDone = false
end

-- //////////////////////////////////////////////////////////////
-- // MAIN FARMING LOGIC
-- //////////////////////////////////////////////////////////////

local function determineAction()
    local round = _G.AltFarmRoundCounter
    local shouldReset = false
    
    -- Alternating logic:
    -- Odd rounds (1,3,5...): Alt 2 resets
    -- Even rounds (2,4,6...): Alt 1 resets
    
    if round % 2 == 1 then
        shouldReset = isSecondAccount
        print("üìä Round " .. round .. " (Odd): Alt 2 should reset")
    else
        shouldReset = isFirstAccount
        print("üìä Round " .. round .. " (Even): Alt 1 should reset")
    end
    
    return shouldReset
end

local function executeDuelRoutine()
    print("\n" .. string.rep("=", 60))
    print("üéÆ EXECUTING DUEL ROUTINE")
    print(string.rep("=", 60))
    
    updateStatus("In duel game - Starting routine...")
    updateRound(_G.AltFarmRoundCounter)
    
    -- Wait 3 seconds after loading
    print("‚è≥ Waiting 3 seconds after load...")
    task.wait(3)
    
    local shouldReset = determineAction()
    
    if shouldReset then
        print("‚úÖ MY TURN TO RESET (Round " .. _G.AltFarmRoundCounter .. ")")
        updateStatus("üîÑ MY TURN - Resetting fast...")
        
        -- Fast reset and teleport
        resetCharacter()
        task.wait(0.5) -- Quick wait
        
        updateStatus("Teleporting back to lobby...")
        teleportToRandomLobbyServer()
        
        print("‚úÖ Duel routine complete - teleporting to random lobby server")
        
    else
        print("‚è≥ OTHER ALT'S TURN - Staying in match (Round " .. _G.AltFarmRoundCounter .. ")")
        updateStatus("‚è≥ Waiting in match (other alt resets)")
        
        -- Just wait here, the other alt will reset and come back
        print("‚úÖ Staying in duel, waiting for completion...")
    end
    
    print(string.rep("=", 60) .. "\n")
end

local function executeLobbyRoutine()
    print("\n" .. string.rep("=", 60))
    print("üè† EXECUTING LOBBY ROUTINE")
    print(string.rep("=", 60))
    
    updateStatus("In lobby - Preparing for next round...")
    
    -- Only teleport once when entering lobby
    if not _G.LobbyTeleportDone then
        -- Step 1: Wait for character to load
        print("‚è≥ Waiting for character to load...")
        task.wait(2)
        local char = waitForCharacterRespawn()
        
        if not char then
            warn("‚ùå Character failed to load in lobby")
            return
        end
        
        -- Step 2: Teleport to spawn position ONCE
        print("üìç Teleporting to spawn position...")
        task.wait(1)
        teleportToPosition(LOBBY_SPAWN_POSITION)
        
        -- Mark teleport as done
        _G.LobbyTeleportDone = true
        
        -- Step 3: Increment round counter
        _G.AltFarmRoundCounter = _G.AltFarmRoundCounter + 1
        updateRound(_G.AltFarmRoundCounter)
        
        print("‚úÖ LOBBY ROUTINE COMPLETE - Ready for Round " .. _G.AltFarmRoundCounter)
        updateStatus("‚úÖ At spawn, ready for next duel (Round " .. _G.AltFarmRoundCounter .. ")")
    else
        print("‚úÖ Already at spawn position, waiting for duel...")
        updateStatus("‚úÖ Waiting at spawn for duel launch...")
    end
    
    print(string.rep("=", 60) .. "\n")
end

-- //////////////////////////////////////////////////////////////
-- // AUTO EXECUTION BASED ON GAME
-- //////////////////////////////////////////////////////////////

local hasExecuted = false

local function checkAndExecute()
    if hasExecuted then return end
    hasExecuted = true
    
    local currentGameId = getCurrentGameId()
    
    print("\nüîç Checking current game ID: " .. currentGameId)
    
    if currentGameId == DUEL_GAME_ID then
        print("‚úÖ DUEL GAME DETECTED!")
        updateStatus("Detected: Duel Game")
        -- Reset lobby teleport flag when entering duel
        _G.LobbyTeleportDone = false
        task.wait(1)
        executeDuelRoutine()
        
    elseif currentGameId == LOBBY_GAME_ID then
        print("‚úÖ LOBBY DETECTED!")
        updateStatus("Detected: Lobby")
        task.wait(1)
        executeLobbyRoutine()
        
    else
        print("‚ùì Unknown game ID: " .. currentGameId)
        updateStatus("Unknown game - Waiting...")
    end
end

-- Execute after a short delay
task.spawn(function()
    print("‚è≥ Waiting 2 seconds before starting routine...")
    task.wait(2)
    checkAndExecute()
end)

-- //////////////////////////////////////////////////////////////
-- // TELEPORT MONITORING
-- //////////////////////////////////////////////////////////////

TeleportService.TeleportInitFailed:Connect(function(player, result, errorMessage)
    warn("‚ùå Teleport failed: " .. errorMessage)
    updateStatus("‚ùå Teleport failed - Retrying...")
    task.wait(3)
    teleportToRandomLobbyServer()
end)

-- Monitor for entering duel game from lobby
local lastGameId = getCurrentGameId()
RunService.Heartbeat:Connect(function()
    local currentGame = getCurrentGameId()
    
    -- Detect game change
    if currentGame ~= lastGameId then
        lastGameId = currentGame
        hasExecuted = false
        
        if currentGame == DUEL_GAME_ID then
            print("üéÆ Entered duel game!")
            _G.LobbyTeleportDone = false -- Reset flag
            task.wait(1)
            checkAndExecute()
        elseif currentGame == LOBBY_GAME_ID then
            print("üè† Entered lobby!")
            task.wait(1)
            checkAndExecute()
        end
    end
end)

-- //////////////////////////////////////////////////////////////
-- // GLOBAL COMMANDS
-- //////////////////////////////////////////////////////////////

_G.stopFarm = function()
    updateStatus("‚ùå Farm manually stopped")
    print("‚èπÔ∏è Farm stopped!")
    if ScreenGui then ScreenGui:Destroy() end
end

_G.resetRound = function()
    _G.AltFarmRoundCounter = 1
    _G.LobbyTeleportDone = false
    updateRound(1)
    print("üîÑ Round counter reset to 1")
end

_G.farmStatus = function()
    print("\nüìä FARM STATUS")
    print("  Account: " .. LocalPlayer.Name)
    print("  Role: " .. accountRole)
    print("  Game ID: " .. getCurrentGameId())
    print("  Round: " .. _G.AltFarmRoundCounter)
    print("  Next Action: " .. (determineAction() and "RESET & RETURN" or "STAY IN MATCH"))
    print("  Lobby Teleport Done: " .. tostring(_G.LobbyTeleportDone))
    print("")
end

_G.skipToLobby = function()
    print("‚è≠Ô∏è Manually skipping to lobby...")
    teleportToRandomLobbyServer()
end

print("\nüí° Commands:")
print("  ‚Ä¢ _G.stopFarm() - Stop the farm")
print("  ‚Ä¢ _G.resetRound() - Reset to Round 1")
print("  ‚Ä¢ _G.farmStatus() - Check current status")
print("  ‚Ä¢ _G.skipToLobby() - Force teleport to lobby")
print("  ‚Ä¢ Press P - Toggle black screen")
print("\n" .. string.rep("=", 60))

print("‚úÖ AUTO-FARM FULLY LOADED AND READY!")
updateStatus("‚úÖ System loaded - Round " .. _G.AltFarmRoundCounter)
